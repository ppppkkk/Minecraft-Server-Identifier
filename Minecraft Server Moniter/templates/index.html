<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MC Monitor | Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-streaming@2.0.0/dist/chartjs-plugin-streaming.min.js"></script>
    <style>
        body { background: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 15px; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: #38bdf8; }
        #console-log { background: #000; color: #10b981; font-family: 'Courier New', monospace; font-size: 0.85rem; height: 180px; overflow-y: auto; border-radius: 0 0 10px 10px; border: 1px solid #334155; border-top: none; }
        .terminal-header { background: #334155; padding: 8px 15px; border-radius: 10px 10px 0 0; font-size: 0.8rem; color: #cbd5e1; border: 1px solid #334155; }
        .btn-clear { font-size: 0.7rem; padding: 2px 8px; color: #94a3b8; border: 1px solid #475569; background: transparent; transition: 0.2s; }
        .btn-clear:hover { background: #ef4444; color: white; border-color: #ef4444; }
    </style>
</head>
<body>
    <div class="container py-4">
        <a href="/" class="btn btn-outline-info btn-sm mb-4">‚Üê Back to Search</a>
        
        <h2 class="mb-4 text-center">Monitoring: <span class="text-info">{{ ip }}</span></h2>

        <div class="row g-4 mb-4">
            <div class="col-md-6">
                <div class="card p-4 text-center">
                    <h6>CURRENT LATENCY</h6>
                    <div id="ping-text" class="stat-value">--</div>
                    <small class="text-muted">ms (millisecond delay)</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card p-4 text-center">
                    <h6>LIVE PLAYERS</h6>
                    <div id="player-text" class="stat-value">--</div>
                    <small class="text-muted">concurrent users</small>
                </div>
            </div>
        </div>

        <div class="card p-4 mb-4">
            <canvas id="liveChart" height="100"></canvas>
        </div>

        <div class="terminal-header d-flex justify-content-between align-items-center">
            <span>SYSTEM CONSOLE LOG</span>
            <button class="btn btn-clear" onclick="clearConsole()">CLEAR LOG</button>
        </div>
        <div id="console-log" class="p-3">
            <div>> Handshake initiated. Monitoring thread attached...</div>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('liveChart').getContext('2d');
        const consoleLog = document.getElementById('console-log');

        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [
                    {
                        label: 'Ping (ms)',
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        data: [],
                        yAxisID: 'y'
                    },
                    {
                        label: 'Players',
                        borderColor: '#fbbf24',
                        backgroundColor: 'rgba(251, 191, 36, 0.1)',
                        borderWidth: 2,
                        tension: 0.3,
                        data: [],
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { intersect: false, mode: 'index' },
                scales: {
                    x: { type: 'realtime', realtime: { delay: 2000, duration: 20000 } },
                    y: { type: 'linear', position: 'left', title: { display: true, text: 'Latency (ms)' }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y1: { type: 'linear', position: 'right', grid: { drawOnChartArea: false }, title: { display: true, text: 'Player Count' } }
                }
            }
        });

        function updateData() {
            fetch('/data')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('ping-text').innerText = data.mc_ping;
                    document.getElementById('player-text').innerText = data.players;

                    chart.data.datasets[0].data.push({ x: Date.now(), y: data.mc_ping });
                    chart.data.datasets[1].data.push({ x: Date.now(), y: data.players });

                    const time = new Date().toLocaleTimeString();
                    const entry = document.createElement('div');
                    
                    if (data.status === "Online") {
                        entry.innerHTML = `[${time}] <span style="color: #38bdf8">SUCCESS:</span> Received packet (Ping: ${data.mc_ping}ms | Pop: ${data.players})`;
                    } else {
                        entry.innerHTML = `[${time}] <span style="color: #f87171">TIMEOUT:</span> Server did not respond. Check status.`;
                    }

                    consoleLog.appendChild(entry);
                    
                    // Auto-scroll logic
                    consoleLog.scrollTop = consoleLog.scrollHeight;

                    // Keep console from using too much memory
                    while (consoleLog.childNodes.length > 30) {
                        consoleLog.removeChild(consoleLog.firstChild);
                    }
                })
                .catch(err => {
                    const errorEntry = document.createElement('div');
                    errorEntry.innerHTML = `<span style="color: #f87171">> CONNECTION ERROR: Local Flask server is down.</span>`;
                    consoleLog.appendChild(errorEntry);
                });
        }

        function clearConsole() {
            consoleLog.innerHTML = '<div>> Console cleared by user.</div>';
        }

        setInterval(updateData, 3000);
    </script>
</body>
</html>